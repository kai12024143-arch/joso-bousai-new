<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JORFOR MAP</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f0f7f9; transition: 0.3s; }
        #map { height: 450px; width: 100%; border-bottom: 2px solid #ddd; }
        header { background: #fff; padding: 12px; text-align: center; border-bottom: 1px solid #eee; transition: 0.3s; }
        h1 { margin: 0; font-size: 1.1rem; }
        .mode-switcher { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #fff; transition: 0.3s; }
        .mode-btn { padding: 6px 12px; border-radius: 20px; border: 2px solid #ddd; cursor: pointer; font-size: 0.85rem; }
        
        #post-form { margin: 15px; padding: 20px; background: #fff; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s; }
        label { display: block; margin-bottom: 15px; font-weight: bold; text-align: center; font-size: 0.9rem; }
        textarea { width: 100%; height: 70px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #eee; padding: 10px; font-size: 16px; box-sizing: border-box; }
        #post-button { padding: 14px; color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; font-size: 1rem; font-weight: bold; transition: 0.3s; }

        .color-selector { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; }
        .circle-btn { width: 42px; height: 42px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .circle-btn.selected { border-color: #333; transform: scale(1.1); }

        .c-pale-green { background: #CAFFBF; } .c-pale-blue { background: #A0C4FF; } .c-pale-yellow { background: #FDFFB6; } .c-pale-red { background: #FFADAD; }
        .c-red { background: #FF0000; } .c-yellow { background: #FFD700; } .c-green { background: #32CD32; }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        body.normal-mode .mode-btn.n-active { background: #4dabf7; color: white; border-color: #4dabf7; }
        body.normal-mode #post-button { background: #4dabf7; }
        body.normal-mode .emergency-btns { display: none; }

        body.emergency-mode { background-color: #2a0a0a; color: white; }
        body.emergency-mode header, body.emergency-mode .mode-switcher { background: #441111; border-color: #552222; }
        body.emergency-mode .mode-btn.e-active { background: #ff0000; color: white; border-color: #ff0000; }
        body.emergency-mode #post-form { background: #441111; }
        body.emergency-mode textarea { background: #552222; border-color: #663333; color: white; }
        body.emergency-mode #post-button { background: #ff0000; }
        body.emergency-mode .normal-btns { display: none; }
        
        .hide-btn { margin-top: 10px; padding: 6px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; color: #666; font-size: 11px; width: 100%; }
        .hide-btn:hover { background: #eee; }

        /* â˜…é‡è¦ï¼šå¹ãå‡ºã—ã®ä¸­ã®æ–‡å­—è‰²ã‚’å¼·åˆ¶çš„ã«é»’ã«ã™ã‚‹ï¼ˆéå¸¸ãƒ¢ãƒ¼ãƒ‰ã®ç™½æ–‡å­—å¯¾ç­–ï¼‰ */
        .gm-style-iw { color: #333 !important; }
        .gm-style-iw div { color: #333 !important; }
    </style>
</head>
<body class="normal-mode">

    <header><h1 id="title">ã˜ã‚‡ã†ãã†ãƒãƒƒãƒ—</h1></header>
    <div class="mode-switcher">
        <div id="m-n" class="mode-btn n-active" onclick="switchMode('normal')">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</div>
        <div id="m-e" class="mode-btn" onclick="switchMode('emergency')">é˜²ç½ãƒ¢ãƒ¼ãƒ‰</div>
    </div>
    <div id="map"></div>
    <form id="post-form">
        <label id="msg-label">ã„ã¾ã®æ§˜å­ã‚’è‰²ã§ãˆã‚‰ã‚“ã§ã­</label>
        <div class="color-selector normal-btns">
            <div class="circle-btn c-pale-green selected" onclick="pick('pale-green', this)"></div>
            <div class="circle-btn c-pale-blue" onclick="pick('pale-blue', this)"></div>
            <div class="circle-btn c-pale-yellow" onclick="pick('pale-yellow', this)"></div>
            <div class="circle-btn c-pale-red" onclick="pick('pale-red', this)"></div>
        </div>
        <div class="color-selector emergency-btns">
            <div class="circle-btn c-red" onclick="pick('red', this)">ğŸš¨</div>
            <div class="circle-btn c-yellow" onclick="pick('yellow', this)">âš ï¸</div>
            <div class="circle-btn c-green" onclick="pick('green', this)">ğŸµ</div>
        </div>
        <input type="hidden" id="selected-val" value="pale-green">
        <textarea id="post-text" placeholder="ã¤ã¶ã‚„ã..."></textarea>
        <button type="submit" id="post-button">ã¿ã‚“ãªã«æ•™ãˆã‚‹</button>
    </form>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBMOr6Kag-PCGL6piRVtjCDukk01aurb1M",
            authDomain: "joso-13c95.firebaseapp.com",
            projectId: "joso-13c95",
            storageBucket: "joso-13c95.firebasestorage.app",
            messagingSenderId: "659788884587",
            appId: "1:659788884587:web:39b9a1b840039c24875f2e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let hiddenPosts = JSON.parse(localStorage.getItem('joso_hidden_posts') || '[]');
        let map, markers = [];
        let allDocsData = []; 
        let currentMode = 'normal';

        function switchMode(m) {
            currentMode = m; 
            document.body.className = m + '-mode';
            document.getElementById('m-n').classList.toggle('n-active', m==='normal');
            document.getElementById('m-e').classList.toggle('e-active', m==='emergency');
            document.getElementById('title').innerText = m==='normal' ? "JORFOR MAP" : "ğŸš¨ é˜²ç½ãƒ¢ãƒ¼ãƒ‰";
            document.getElementById('msg-label').innerText = m==='normal' ? "ä»Šã®æ°—æŒã¡ã‚’é¸ã¶" : "è¢«å®³çŠ¶æ³ã‚’é¸ã¶";
            document.getElementById('post-button').innerText = m==='normal' ? "ã¿ã‚“ãªã«æ•™ãˆã‚‹" : "æŠ•ç¨¿ã™ã‚‹";
            
            const firstBtn = document.querySelector('.' + (m==='normal' ? 'normal-btns' : 'emergency-btns') + ' .circle-btn');
            pick(m==='normal' ? 'pale-green' : 'red', firstBtn);
            renderMarkers();
        }

        function pick(val, el) {
            document.getElementById('selected-val').value = val;
            document.querySelectorAll('.circle-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function hidePost(id) {
            if (confirm("ã“ã®æŠ•ç¨¿ã‚’éè¡¨ç¤ºã«ã—ã¾ã™ã‹ï¼Ÿ")) {
                hiddenPosts.push(id);
                localStorage.setItem('joso_hidden_posts', JSON.stringify(hiddenPosts));
                renderMarkers(); 
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14, center: { lat: 35.9897, lng: 139.9791 },
                disableDefaultUI: true, zoomControl: true
            });
            load();
        }

        function load() {
            db.collection('posts').orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                allDocsData = [];
                snap.forEach(doc => {
                    allDocsData.push({ id: doc.id, data: doc.data() });
                });
                renderMarkers();
            });
        }

        function renderMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];

            allDocsData.forEach(item => {
                const d = item.data;
                const id = item.id;

                if (hiddenPosts.includes(id)) return;
                if(!d.lat || !d.lng) return;

                // é˜²ç½ãƒ¢ãƒ¼ãƒ‰ãªã‚‰é€šå¸¸ï¼ˆpale-ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (currentMode === 'emergency' && d.category.startsWith('pale-')) return;

                let color = "#A0C4FF", size = 22, z = 1;
                const labels = {'red':'ğŸš¨æ•‘åŠ©','yellow':'âš ï¸è¢«å®³','green':'âœ…ç„¡äº‹','pale-red':'æ³¨æ„','pale-blue':'ç”Ÿæ´»','pale-yellow':'ç™ºè¦‹','pale-green':'è‡ªç„¶'};
                
                switch(d.category) {
                    case 'red': color='#ff0000'; size=50; z=100; break;
                    case 'yellow': color='#ffd700'; size=30; z=50; break;
                    case 'green': color='#32cd32'; size=25; break;
                    case 'pale-red': color='#ffadad'; break;
                    case 'pale-blue': color='#a0c4ff'; break;
                    case 'pale-yellow': color='#fdffb6'; break;
                    case 'pale-green': color='#caffbf'; break;
                }

                const m = new google.maps.Marker({
                    position: {lat:d.lat, lng:d.lng}, map: map, zIndex: z,
                    icon: { path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z', fillColor: color, fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2, scale: size/20 }
                });

                // â˜…ã“ã“ãŒä¿®æ­£ç‚¹ï¼šæŠ•ç¨¿ç›´å¾Œ(timestampãŒnull)ã®æ™‚ã¯ã€ä»®ã«ä»Šã®æ™‚é–“ã‚’å…¥ã‚Œã‚‹
                let dateObj = d.timestamp ? d.timestamp.toDate() : new Date();
                const time = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const iw = new google.maps.InfoWindow({ 
                    content: `<div style="color:#333; font-size:14px; min-width:160px; font-weight:500;">
                                <div style="margin-bottom:5px; color:#555; font-size:12px;">
                                    â° ${time} ã€${labels[d.category]||'æƒ…å ±'}ã€‘
                                </div>
                                <div style="font-size:15px;">${d.text}</div>
                                <button class="hide-btn" onclick="hidePost('${id}')">ğŸ‘ éè¡¨ç¤ºã«ã™ã‚‹</button>
                              </div>` 
                });
                m.addListener('click', () => iw.open(map, m));
                markers.push(m);
            });
        }

        document.getElementById('post-form').addEventListener('submit', e => {
            e.preventDefault();
            const txt = document.getElementById('post-text').value;
            const cat = document.getElementById('selected-val').value;
            if(!txt.trim()) return;

            navigator.geolocation.getCurrentPosition(p => {
                const loc = {lat: p.coords.latitude, lng: p.coords.longitude};
                db.collection('posts').add({
                    text: txt, category: cat, lat: loc.lat, lng: loc.lng,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    document.getElementById('post-text').value = '';
                    map.panTo(loc);
                });
            }, () => alert("ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„"));
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7hvh-OUCTVM62geqN543IMtgEWl-eeTQ&callback=initMap"></script>
</body>
</html>
