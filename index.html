<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JORFOR MAP</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif; margin: 0; background-color: #f8fafc; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
#map { height: 50vh; width: 100%; border-bottom: none; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æµ®ã‹ã›ã‚‹ */
header { background: #fff; padding: 16px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; z-index: 10; }
h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; color: #334155; }

/* åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒ–é¢¨ã« */
.mode-switcher { display: flex; justify-content: center; gap: 0; padding: 12px; background: #fff; }
.mode-btn { padding: 10px 24px; border-radius: 0; border: 1px solid #e2e8f0; cursor: pointer; font-size: 0.9rem; transition: 0.3s; background: #f1f5f9; color: #64748b; }
.mode-btn:first-child { border-radius: 8px 0 0 8px; }
.mode-btn:last-child { border-radius: 0 8px 8px 0; }

/* æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ã« */
#post-form { 
    margin: -20px 16px 20px 16px; 
    padding: 24px; 
    background: #fff; 
    border-radius: 20px; 
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); 
    position: relative; 
    z-index: 20; 
}

/* å…¥åŠ›ã‚¨ãƒªã‚¢ã®è£…é£¾ */
textarea { 
    width: 100%; border-radius: 12px; border: 1px solid #e2e8f0; padding: 12px; 
    font-size: 16px; transition: 0.3s; background: #f8fafc; 
}
textarea:focus { border-color: #3b82f6; outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }

/* ãƒœã‚¿ãƒ³ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
#post-button { 
    padding: 16px; border-radius: 12px; width: 100%; font-size: 1rem; 
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); transition: 0.3s;
}
#post-button:active { transform: scale(0.98); }

/* éå¸¸æ™‚ãƒ¢ãƒ¼ãƒ‰ã®é…è‰²ã‚’ã‚ˆã‚Šç·Šè¿«æ„Ÿã®ã‚ã‚‹ã‚‚ã®ã« */
body.emergency-mode { background-color: #1a0505; }
body.emergency-mode #post-form { background: #2d0a0a; border: 1px solid #4a1010; color: #fff; }
body.emergency-mode textarea { background: #3d1414; border-color: #5a1a1a; color: #fff; }
body.emergency-mode #post-button { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); }
    </style>
</head>
<body class="normal-mode">
    <header><h1 id="title">JORFOR MAP</h1></header>
    <div class="mode-switcher">
        <div id="m-n" class="mode-btn n-active" onclick="switchMode('normal')">é€šå¸¸æ™‚ãƒ¢ãƒ¼ãƒ‰</div>
        <div id="m-e" class="mode-btn" onclick="switchMode('emergency')">éå¸¸æ™‚ãƒ¢ãƒ¼ãƒ‰</div>
    </div>
    <div id="map"></div>
    <form id="post-form">
        <div class="normal-ui">
            <div class="color-selector">
                <div class="circle-btn c-pale-green selected" onclick="pick('pale-green', this, '')"></div>
                <div class="circle-btn c-pale-blue" onclick="pick('pale-blue', this, '')"></div>
                <div class="circle-btn c-pale-yellow" onclick="pick('pale-yellow', this, '')"></div>
                <div class="circle-btn c-pale-red" onclick="pick('pale-red', this, '')"></div>
            </div>
        </div>
        <div class="emergency-ui">
            <div class="color-selector">
                <div class="circle-btn c-red" onclick="pick('red', this, 'ğŸš¨ æ•‘åŠ©è¦è«‹')"></div>
                <div class="circle-btn c-yellow" onclick="pick('yellow', this, 'âš ï¸ è¢«å®³ã‚ã‚Š')"></div>
                <div class="circle-btn c-green" onclick="pick('green', this, 'ğŸµ è¢«å®³ãªã—')"></div>
            </div>
            <div id="btn-desc" class="btn-guide">ğŸš¨ æ•‘åŠ©è¦è«‹</div>
        </div>

        <input type="hidden" id="selected-val" value="pale-green">
        <img id="image-preview">
        <textarea id="post-text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
        
        <div class="file-input-wrapper">
            <input type="file" id="image-input" accept="image/*" style="display:none">
            <button type="button" onclick="document.getElementById('image-input').click()" style="background:#eee; border:1px solid #ccc; padding:5px 10px; border-radius:5px; font-size:0.8rem;">å†™çœŸã‚’è¿½åŠ ã™ã‚‹</button>
        </div>

        <button type="submit" id="post-button">æŠ•ç¨¿ã™ã‚‹</button>
    </form>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBMOr6Kag-PCGL6piRVtjCDukk01aurb1M",
            authDomain: "joso-13c95.firebaseapp.com",
            projectId: "joso-13c95",
            storageBucket: "joso-13c95.appspot.com",
            messagingSenderId: "659788884587",
            appId: "1:659788884587:web:39b9a1b840039c24875f2e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let hiddenPosts = JSON.parse(localStorage.getItem('joso_hidden_posts') || '[]');
        let map, markers = [];
        let allDocsData = []; 
        let currentMode = 'normal';
        let currentImageData = null;

        document.getElementById('image-input').onchange = e => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 800000) { 
                    alert("ç”»åƒãŒå¤§ãã™ãã¾ã™ã€‚ã‚‚ã†å°‘ã—å°ã•ã„ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    currentImageData = e.target.result;
                    const preview = document.getElementById('image-preview');
                    preview.src = currentImageData;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };

        function switchMode(m) {
            currentMode = m; 
            document.body.className = m + '-mode';
            document.getElementById('m-n').classList.toggle('n-active', m==='normal');
            document.getElementById('m-e').classList.toggle('e-active', m==='emergency');
            m === 'normal' ? pick('pale-green', document.querySelector('.normal-ui .circle-btn'), '') : pick('red', document.querySelector('.emergency-ui .circle-btn'), 'ğŸš¨ æ•‘åŠ©è¦è«‹ï¼ˆè‡³æ€¥ï¼ï¼‰');
            renderMarkers();
        }

        function pick(val, el, desc) {
            document.getElementById('selected-val').value = val;
            document.querySelectorAll('.circle-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('btn-desc').innerText = desc;
        }

        function hidePost(id) {
            if (confirm("ã“ã®æŠ•ç¨¿ã‚’éè¡¨ç¤ºã«ã—ã¾ã™ã‹ï¼Ÿ")) {
                hiddenPosts.push(id);
                localStorage.setItem('joso_hidden_posts', JSON.stringify(hiddenPosts));
                renderMarkers(); 
            }
        }

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 14, 
        center: { lat: 35.9897, lng: 139.9791 },
        disableDefaultUI: true, 
        zoomControl: true,
        // ã“ã“ã«åœ°å›³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆStylesï¼‰ã‚’è¿½åŠ 
        styles: [
            { "featureType": "water", "elementType": "geometry", "stylers": [{ "color": "#e9e9e9" }, { "lightness": 17 }] },
            { "featureType": "landscape", "elementType": "geometry", "stylers": [{ "color": "#f5f5f5" }, { "lightness": 20 }] },
            { "featureType": "road.highway", "elementType": "geometry.fill", "stylers": [{ "color": "#ffffff" }, { "lightness": 17 }] },
            { "featureType": "poi", "elementType": "geometry", "stylers": [{ "color": "#f5f5f5" }, { "lightness": 21 }] }
        ]
    });
    load();
}

        function load() {
            const yesterday = new Date();
            yesterday.setHours(yesterday.getHours() - 24);

            db.collection('posts')
                .where('timestamp', '>=', yesterday)
                .orderBy('timestamp', 'desc')
                .onSnapshot(snap => {
                    allDocsData = [];
                    snap.forEach(doc => { allDocsData.push({ id: doc.id, data: doc.data() }); });
                    renderMarkers();
                }, err => {
                    console.error("Firestore Error:", err);
                    // âš ï¸ ã“ã“ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã€ŒIndexãŒå¿…è¦ã€ã¨ã„ã†ãƒªãƒ³ã‚¯ãŒå‡ºãŸã‚‰ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½œæˆã—ã¦ãã ã•ã„
                });
        }

        function renderMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];
            
            const emergencyLabels = {
                'red': 'ğŸš¨ æ•‘åŠ©è¦è«‹',
                'yellow': 'âš ï¸ è¢«å®³ã‚ã‚Š',
                'green': 'ğŸµ è¢«å®³ãªã—'
            };

            allDocsData.forEach((item, index) => {
                const d = item.data;
                const id = item.id;
                const cat = d.category;
                if (hiddenPosts.includes(id) || !d.lat || !d.lng) return;
                if (currentMode === 'emergency' && cat.startsWith('pale-')) return;

                let color = "#A0C4FF", size = 22;
                switch(cat) {
                    case 'red': color='#ff0000'; size=50; break;
                    case 'yellow': color='#ffd700'; size=30; break;
                    case 'green': color='#32cd32'; size=25; break;
                    case 'pale-red': color='#ffadad'; break;
                    case 'pale-blue': color='#a0c4ff'; break;
                    case 'pale-yellow': color='#fdffb6'; break;
                    case 'pale-green': color='#caffbf'; break;
                }

                const m = new google.maps.Marker({
                    position: {lat: d.lat + (Math.random()-0.5)*0.0002, lng: d.lng + (Math.random()-0.5)*0.0002}, 
                    map: map,
                    icon: { path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z', fillColor: color, fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2, scale: size/20 }
                });

                let dateObj = d.timestamp ? d.timestamp.toDate() : new Date();
                const time = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const imgHtml = d.imageUrl ? `<img src="${d.imageUrl}" class="iw-img">` : '';
                
                // éå¸¸æ™‚ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã ã‘å¹ãå‡ºã—å†…ã«ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
                const labelHtml = (currentMode === 'emergency' && emergencyLabels[cat]) 
                    ? `<div style="color:red; font-weight:bold; font-size:14px; margin-bottom:4px;">${emergencyLabels[cat]}</div>` 
                    : '';

                const iw = new google.maps.InfoWindow({ 
                    content: `<div style="color:#333; min-width:180px; max-width:200px;">
                                <div style="margin-bottom:5px; color:#777; font-size:11px;">${time}</div>
                                ${labelHtml}
                                <div style="font-size:14px; font-weight:bold;">${d.text}</div>
                                ${imgHtml}
                                <button class="hide-btn" onclick="hidePost('${id}')">éè¡¨ç¤ºã«ã™ã‚‹</button>
                              </div>` 
                });
                m.addListener('click', () => iw.open(map, m));
                markers.push(m);
            });
        }

        document.getElementById('post-form').addEventListener('submit', async e => {
            e.preventDefault();
            const txt = document.getElementById('post-text').value;
            const cat = document.getElementById('selected-val').value;
            if(!txt.trim() && !currentImageData) return;

            const btn = document.getElementById('post-button');
            btn.disabled = true;
            btn.innerText = "é€ä¿¡ä¸­...";

            navigator.geolocation.getCurrentPosition(async p => {
                const loc = {lat: p.coords.latitude, lng: p.coords.longitude};
                db.collection('posts').add({
                    text: txt, category: cat, lat: loc.lat, lng: loc.lng,
                    imageUrl: currentImageData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert("âœ… æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                    document.getElementById('post-text').value = '';
                    document.getElementById('image-input').value = '';
                    document.getElementById('image-preview').style.display = 'none';
                    currentImageData = null;
                    btn.disabled = false;
                    btn.innerText = "æŠ•ç¨¿ã™ã‚‹";
                    map.panTo(loc);
                }).catch(err => {
                    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                    btn.disabled = false;
                });
            }, () => {
                alert("ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„");
                btn.disabled = false;
            });
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7hvh-OUCTVM62geqN543IMtgEWl-eeTQ&callback=initMap"></script>
</body>
</html>
