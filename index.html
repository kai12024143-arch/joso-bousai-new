<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã˜ã‚‡ã†ãã†ãƒãƒƒãƒ—</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; transition: background-color 0.3s, color 0.3s; background-color: #f0f7f9; color: #333; touch-action: manipulation; }
        #map { height: 450px; width: 100%; border-bottom: 2px solid #ddd; }
        
        header { background: #fff; padding: 12px; text-align: center; border-bottom: 1px solid #eee; transition: 0.3s; }
        h1 { margin: 0; font-size: 1.2rem; }

        /* --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ --- */
        .mode-switcher { display: flex; justify-content: center; gap: 10px; padding: 15px; background: #fff; transition: 0.3s; }
        .mode-btn { padding: 8px 16px; border-radius: 20px; border: 2px solid #ddd; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.9rem; }

        /* --- ãƒ•ã‚©ãƒ¼ãƒ å…±é€š --- */
        #post-form { margin: 20px; padding: 20px; background: #fff; border-radius: 15px; transition: 0.3s; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        label { display: block; margin-bottom: 10px; font-weight: bold; font-size: 0.95rem; transition: 0.3s; text-align: center; }
        textarea { width: 100%; height: 80px; margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px; font-size: 16px; box-sizing: border-box; resize: none; }
        #post-button { padding: 15px; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem; transition: 0.3s; }

        /* --- ã€æ–°æ©Ÿèƒ½ã€‘ä¸¸ã„è‰²ãƒœã‚¿ãƒ³UI (é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ç”¨) --- */
        .color-btn-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .color-btn { width: 45px; height: 45px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .color-btn.selected { border-color: #555; transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        /* ãƒœã‚¿ãƒ³ã®è‰²å®šç¾© */
        .btn-pale-green { background: #CAFFBF; }
        .btn-pale-blue { background: #A0C4FF; }
        .btn-pale-yellow { background: #FDFFB6; }
        .btn-pale-red { background: #FFADAD; }
        /* é¸æŠä¸­ã®ãƒ©ãƒ™ãƒ« */
        #selected-color-label { text-align: center; margin-bottom: 15px; font-size: 0.9rem; color: #666; font-weight: bold; min-height: 1.2em; }

        /* --- ç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ --- */
        #emergency-select { width: 100%; margin-bottom: 15px; padding: 12px; font-size: 16px; border-radius: 10px; border: 1px solid #ddd; }

        /* ====== ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« ====== */
        /* é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ */
        body.normal-mode { background-color: #f0f7f9; }
        .normal-mode header h1 { color: #007bff; }
        .normal-mode .mode-btn.active { background: #4dabf7; color: white; border-color: #4dabf7; }
        .normal-mode #post-button { background: #4dabf7; }
        .normal-mode #post-button:hover { background: #339af0; }
        /* é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç·Šæ€¥ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’éš ã™ */
        .normal-mode #emergency-select-container { display: none; }

        /* é˜²ç½ãƒ¢ãƒ¼ãƒ‰ */
        body.emergency-mode { background-color: #2a0a0a; color: #f0f0f0; }
        .emergency-mode header { background: #441111; border-bottom-color: #552222; }
        .emergency-mode header h1 { color: #ff4444; }
        .emergency-mode .mode-switcher { background: #441111; }
        .emergency-mode .mode-btn { border-color: #662222; color: #ddd; }
        .emergency-mode .mode-btn.active { background: #d32f2f; color: white; border-color: #d32f2f; }
        .emergency-mode #post-form { background: #441111; box-shadow: 0 4px 15px rgba(255, 50, 50, 0.2); }
        .emergency-mode label { color: #ffcccc; }
        .emergency-mode textarea, .emergency-mode #emergency-select { background: #552222; border-color: #663333; color: white; }
        .emergency-mode #post-button { background: #d32f2f; }
        .emergency-mode #post-button:hover { background: #b71c1c; }
        /* é˜²ç½ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä¸¸ãƒœã‚¿ãƒ³UIã‚’éš ã™ */
        .emergency-mode #normal-color-ui { display: none; }
    </style>
</head>
<body class="normal-mode">

    <header>
        <h1 id="main-title">ã˜ã‚‡ã†ãã†ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—</h1>
    </header>

    <div class="mode-switcher">
        <div id="btn-normal" class="mode-btn active" onclick="switchMode('normal')">ğŸŒ¸ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</div>
        <div id="btn-emergency" class="mode-btn" onclick="switchMode('emergency')">ğŸš¨ é˜²ç½ãƒ¢ãƒ¼ãƒ‰</div>
    </div>

    <div id="map"></div>

    <form id="post-form">
        <label id="form-label">ã„ã¾ã®æ§˜å­ã‚’è‰²ã§ãˆã‚‰ã‚“ã§ã­</label>

        <div id="normal-color-ui">
            <div class="color-btn-container">
                <div class="color-btn btn-pale-green selected" onclick="selectColor('pale-green', 'ğŸŒ¿ è‡ªç„¶ãƒ»å…¬åœ’', this)"></div>
                <div class="color-btn btn-pale-blue" onclick="selectColor('pale-blue', 'ğŸ’§ é“è·¯ãƒ»ç”Ÿæ´»', this)"></div>
                <div class="color-btn btn-pale-yellow" onclick="selectColor('pale-yellow', 'âœ¨ ãŠåº—ãƒ»ç™ºè¦‹', this)"></div>
                <div class="color-btn btn-pale-red" onclick="selectColor('pale-red', 'ğŸ’¦ ã¡ã‚‡ã£ã¨æ³¨æ„', this)"></div>
            </div>
            <div id="selected-color-label">ğŸŒ¿ è‡ªç„¶ãƒ»å…¬åœ’ï¼ˆé¸æŠä¸­ï¼‰</div>
        </div>

        <div id="emergency-select-container">
            <select id="emergency-select">
                <option value="red">ğŸš¨ æ•‘åŠ©è¦è«‹ï¼ˆè‡³æ€¥ï¼ï¼‰</option>
                <option value="yellow">ğŸŸ¡ è¢«å®³ã‚ã‚Šï¼ˆæµ¸æ°´ãƒ»æå£Šï¼‰</option>
                <option value="green">ğŸŸ¢ è¢«å®³ãªã—ï¼ˆç„¡äº‹å ±å‘Šï¼‰</option>
            </select>
        </div>

        <input type="hidden" id="final-category" value="pale-green">

        <textarea id="post-text" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
        <button type="submit" id="post-button">ã¿ã‚“ãªã«æ•™ãˆã‚‹</button>
    </form>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBMOr6Kag-PCGL6piRVtjCDukk01aurb1M",
            authDomain: "joso-13c95.firebaseapp.com",
            projectId: "joso-13c95",
            storageBucket: "joso-13c95.firebasestorage.app",
            messagingSenderId: "659788884587",
            appId: "1:659788884587:web:39b9a1b840039c24875f2e"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let map;
        let markers = [];
        let currentMode = 'normal'; // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’è¨˜æ†¶

        // --- ã€æ–°æ©Ÿèƒ½ã€‘ä¸¸ãƒœã‚¿ãƒ³ã®è‰²é¸æŠå‡¦ç† ---
        function selectColor(colorVal, labelText, btnElement) {
            // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('final-category').value = colorVal;
            // ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
            document.getElementById('selected-color-label').innerText = labelText + 'ï¼ˆé¸æŠä¸­ï¼‰';
            // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');
        }

        // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿å‡¦ç† ---
        function switchMode(mode) {
            currentMode = mode;
            const body = document.body;
            const title = document.getElementById('main-title');
            const label = document.getElementById('form-label');
            const btn = document.getElementById('post-button');
            
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));

            if (mode === 'normal') {
                body.className = 'normal-mode';
                document.getElementById('btn-normal').classList.add('active');
                title.innerText = "ã˜ã‚‡ã†ãã†ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—";
                label.innerText = "ã„ã¾ã®æ§˜å­ã‚’è‰²ã§ãˆã‚‰ã‚“ã§ã­";
                btn.innerText = "ã¿ã‚“ãªã«æ•™ãˆã‚‹";
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸå€¤ã«æˆ»ã™
                const defaultBtn = document.querySelector('.btn-pale-green');
                selectColor('pale-green', 'ğŸŒ¿ è‡ªç„¶ãƒ»å…¬åœ’', defaultBtn);
            } else {
                body.className = 'emergency-mode';
                document.getElementById('btn-emergency').classList.add('active');
                title.innerText = "ã€ç·Šæ€¥ã€‘å¸¸ç·é˜²ç½ãƒãƒƒãƒ—";
                label.innerText = "ã€é‡è¦ã€‘è¢«å®³çŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„";
                btn.innerText = "ç·Šæ€¥æƒ…å ±ã‚’æŠ•ç¨¿ã™ã‚‹";
            }
        }

        function initMap() {
            // åˆæœŸã‚ºãƒ¼ãƒ ã‚’å°‘ã—å¼•ã„ã¦å…¨ä½“æ„Ÿã‚’è¦‹ã‚„ã™ã
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13, center: { lat: 35.9897, lng: 139.9791 },
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });
            loadPosts(); 
        }

        // SVGãƒ”ãƒ³ä½œæˆé–¢æ•°
        function createMarkerIcon(color, size) {
            return {
                path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z',
                fillColor: color, fillOpacity: 0.95, strokeColor: '#fff', strokeWeight: 2, scale: size / 20,
                labelOrigin: new google.maps.Point(0, -35)
            };
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼åã‚’æ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getCategoryLabel(cat) {
            const labels = {
                'red': 'ğŸš¨ æ•‘åŠ©è¦è«‹', 'yellow': 'ğŸŸ¡ è¢«å®³ã‚ã‚Š', 'green': 'ğŸŸ¢ è¢«å®³ãªã—',
                'pale-green': 'ğŸŒ¿ è‡ªç„¶ãƒ»å…¬åœ’', 'pale-blue': 'ğŸ’§ é“è·¯ãƒ»ç”Ÿæ´»',
                'pale-yellow': 'âœ¨ ãŠåº—ãƒ»ç™ºè¦‹', 'pale-red': 'ğŸ’¦ ã¡ã‚‡ã£ã¨æ³¨æ„'
            };
            return labels[cat] || 'æƒ…å ±';
        }

        function loadPosts() {
            markers.forEach(m => m.setMap(null));
            markers = [];
            db.collection('posts').orderBy('timestamp', 'desc').limit(50).onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        if(!data.lat || !data.lng) return;

                        let color = "#A0C4FF"; let size = 22; let zIdx = 1;
                        switch(data.category) {
                            case "red": color = "#FF0000"; size = 50; zIdx = 100; break;
                            case "yellow": color = "#FFD700"; size = 30; zIdx = 50; break;
                            case "green": color = "#32CD32"; size = 25; zIdx = 20; break;
                            case "pale-red": color = "#FFADAD"; break;
                            case "pale-blue": color = "#A0C4FF"; break;
                            case "pale-yellow": color = "#FDFFB6"; break;
                            case "pale-green": color = "#CAFFBF"; break;
                        }

                        const marker = new google.maps.Marker({
                            position: { lat: data.lat, lng: data.lng },
                            map: map,
                            icon: createMarkerIcon(color, size),
                            zIndex: zIdx,
                            animation: google.maps.Animation.DROP
                        });

                        // --- ã€æ–°æ©Ÿèƒ½ã€‘æ™‚åˆ»ã¨çŠ¶æ…‹ã®è¡¨ç¤º ---
                        let timeStr = "";
                        if (data.timestamp) {
                            const date = data.timestamp.toDate();
                            timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                        }
                        const catLabel = getCategoryLabel(data.category);
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div style="padding:5px; color:#333; max-width:220px;">
                                    <div style="font-size:0.85rem; color:#666; margin-bottom:5px;">
                                        ğŸ•’ ${timeStr} ã€${catLabel}ã€‘
                                    </div>
                                    <div style="font-size:1rem;">${data.text}</div>
                                </div>
                            `
                        });
                        marker.addListener('click', () => infoWindow.open(map, marker));
                        markers.push(marker);
                    }
                });
            });
        }

        document.getElementById('post-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = document.getElementById('post-text').value;
            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦é€ä¿¡ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å–å¾—å…ƒã‚’å¤‰ãˆã‚‹
            let category;
            if (currentMode === 'normal') {
                category = document.getElementById('final-category').value; // ä¸¸ãƒœã‚¿ãƒ³ã®å€¤
            } else {
                category = document.getElementById('emergency-select').value; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤
            }
            
            if (!text.trim()) return;

            const submitBtn = document.getElementById('post-button');
            submitBtn.disabled = true; submitBtn.innerText = 'é€ä¿¡ä¸­...';

            navigator.geolocation.getCurrentPosition((pos) => {
                const userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                db.collection('posts').add({
                    text: text, category: category,
                    lat: userLoc.lat, lng: userLoc.lng,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    document.getElementById('post-text').value = '';
                    submitBtn.disabled = false; submitBtn.innerText = currentMode === 'normal' ? 'ã¿ã‚“ãªã«æ•™ãˆã‚‹' : 'ç·Šæ€¥æƒ…å ±ã‚’æŠ•ç¨¿ã™ã‚‹';
                    // --- ã€æ”¹å–„ã€‘æŠ•ç¨¿æ™‚ã«åœ°å›³ã‚’ç¾åœ¨åœ°ã«ã‚¹ãƒ ãƒ¼ã‚ºã«ç§»å‹•ï¼ˆã‚ºãƒ¼ãƒ ã¯å¤‰ãˆãªã„ï¼‰ ---
                    map.panTo(userLoc); 
                });
            }, () => {
                alert("ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„");
                submitBtn.disabled = false; submitBtn.innerText = 'å†è©¦è¡Œ';
            }, { enableHighAccuracy: true });
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7hvh-OUCTVM62geqN543IMtgEWl-eeTQ&callback=initMap"></script>
</body>
</html>
