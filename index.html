<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã˜ã‚‡ã†ãã†ãƒãƒƒãƒ—</title>
    <style>
        /* åŸºæœ¬è¨­å®š */
        body { font-family: sans-serif; margin: 0; transition: 0.3s; background-color: #f0f7f9; }
        #map { height: 450px; width: 100%; border-bottom: 2px solid #ddd; }
        
        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ã®ã‚¨ãƒªã‚¢ */
        .mode-switcher {
            display: flex; justify-content: center; gap: 10px; padding: 15px; background: #fff;
        }
        .mode-btn {
            padding: 10px 20px; border-radius: 20px; border: 2px solid #ddd; cursor: pointer; font-weight: bold; transition: 0.3s;
        }

        /* --- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body.normal-mode { background-color: #f0f7f9; }
        .normal-mode .mode-btn.active { background: #4dabf7; color: white; border-color: #4dabf7; }
        .normal-mode h1 { color: #007bff; }
        .normal-mode #post-button { background: #4dabf7; }

        /* --- é˜²ç½ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body.emergency-mode { background-color: #330000; color: white; }
        .emergency-mode .mode-btn.active { background: #ff0000; color: white; border-color: #ff0000; }
        .emergency-mode h1 { color: #ff4444; }
        .emergency-mode #post-form { background: #441111; color: white; box-shadow: 0 4px 15px rgba(255,0,0,0.3); }
        .emergency-mode #post-button { background: #ff0000; font-size: 1.2rem; }
        .emergency-mode label { color: #ffcccc; }

        /* å…±é€šãƒ•ã‚©ãƒ¼ãƒ  */
        header { background: #fff; padding: 10px; text-align: center; border-bottom: 1px solid #eee; transition: 0.3s; }
        .emergency-mode header { background: #000; border-bottom: 1px solid #555; }
        
        #post-form { margin: 20px; padding: 20px; background: #fff; border-radius: 15px; transition: 0.3s; }
        select, textarea { width: 100%; margin-bottom: 15px; border-radius: 10px; padding: 12px; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; }
        #post-button { padding: 15px; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
    </style>
</head>
<body class="normal-mode"> <header>
        <h1 id="main-title">ã˜ã‚‡ã†ãã†ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—</h1>
    </header>

    <div class="mode-switcher">
        <div id="btn-normal" class="mode-btn active" onclick="switchMode('normal')">é€šå¸¸æ™‚ãƒ¢ãƒ¼ãƒ‰</div>
        <div id="btn-emergency" class="mode-btn" onclick="switchMode('emergency')">éå¸¸æ™‚ãƒ¢ãƒ¼ãƒ‰</div>
    </div>

    <div id="map"></div>

    <form id="post-form">
        <label id="form-label">ã„ã¾ã®æ§˜å­ã‚’ã‚·ã‚§ã‚¢</label>
        <select id="post-category">
            </select>
        <textarea id="post-text" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
        <button type="submit" id="post-button">ã¿ã‚“ãªã«æ•™ãˆã‚‹</button>
    </form>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBMOr6Kag-PCGL6piRVtjCDukk01aurb1M",
            authDomain: "joso-13c95.firebaseapp.com",
            projectId: "joso-13c95",
            storageBucket: "joso-13c95.firebasestorage.app",
            messagingSenderId: "659788884587",
            appId: "1:659788884587:web:39b9a1b840039c24875f2e"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let map;
        let markers = [];

        // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã®å‡¦ç† ---
        function switchMode(mode) {
            const body = document.body;
            const title = document.getElementById('main-title');
            const label = document.getElementById('form-label');
            const btn = document.getElementById('post-button');
            const select = document.getElementById('post-category');
            
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));

            if (mode === 'normal') {
                body.className = 'normal-mode';
                document.getElementById('btn-normal').classList.add('active');
                title.innerText = "ã˜ã‚‡ã†ãã†ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒƒãƒ—";
                label.innerText = "ã„ã¾ã®æ§˜å­ã‚’ã‚·ã‚§ã‚¢";
                btn.innerText = "ã¿ã‚“ãªã«æ•™ãˆã‚‹";
                // é€šå¸¸æ™‚ã®é¸æŠè‚¢
                select.innerHTML = `
                    <option value="pale-green">æ·¡ã„ç·‘</option>
                    <option value="pale-blue">æ·¡ã„é’</option>
                    <option value="pale-yellow">æ·¡ã„é»„</option>
                    <option value="pale-red">æ·¡ã„èµ¤</option>
                `;
            } else {
                body.className = 'emergency-mode';
                document.getElementById('btn-emergency').classList.add('active');
                title.innerText = "ã€ç·Šæ€¥ã€‘å¸¸ç·é˜²ç½ãƒãƒƒãƒ—";
                label.innerText = "ã€é‡è¦ã€‘è¢«å®³ãƒ»æ•‘åŠ©çŠ¶æ³ã‚’å ±å‘Š";
                btn.innerText = "ç·Šæ€¥æƒ…å ±ã‚’æŠ•ç¨¿ã™ã‚‹";
                // é˜²ç½æ™‚ã®é¸æŠè‚¢
                select.innerHTML = `
                    <option value="red">ğŸš¨ æ•‘åŠ©è¦è«‹ï¼ˆè‡³æ€¥ï¼ï¼‰</option>
                    <option value="yellow">ğŸŸ¡ è¢«å®³ã‚ã‚Šï¼ˆæµ¸æ°´ãƒ»æå£Šï¼‰</option>
                    <option value="green">ğŸŸ¢ è¢«å®³ãªã—ï¼ˆç„¡äº‹å ±å‘Šï¼‰</option>
                `;
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14, center: { lat: 35.9897, lng: 139.9791 }
            });
            switchMode('normal'); // æœ€åˆã¯é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
            loadPosts(); 
        }

        function createMarkerIcon(color, size) {
            return {
                path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z',
                fillColor: color, fillOpacity: 0.9, strokeColor: '#fff', strokeWeight: 2, scale: size / 20
            };
        }

        function loadPosts() {
            markers.forEach(m => m.setMap(null));
            markers = [];
            db.collection('posts').orderBy('timestamp', 'desc').limit(50).get().then((snapshot) => {
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    let color = "#A0C4FF"; let size = 20; 
                    switch(data.category) {
                        case "red": color = "#FF0000"; size = 45; break;
                        case "yellow": color = "#FFD700"; size = 30; break;
                        case "green": color = "#32CD32"; size = 25; break;
                        case "pale-red": color = "#FFADAD"; size = 20; break;
                        case "pale-blue": color = "#A0C4FF"; size = 20; break;
                        case "pale-yellow": color = "#FDFFB6"; size = 20; break;
                        case "pale-green": color = "#CAFFBF"; size = 20; break;
                    }
                    const marker = new google.maps.Marker({
                        position: { lat: data.lat, lng: data.lng },
                        map: map,
                        icon: createMarkerIcon(color, size),
                        zIndex: (data.category === "red") ? 100 : 1
                    });
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="color:#333;">${data.text}</div>`
                    });
                    marker.addListener('click', () => infoWindow.open(map, marker));
                    markers.push(marker);
                });
            });
        }

        document.getElementById('post-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = document.getElementById('post-text').value;
            const category = document.getElementById('post-category').value;
            if (!text.trim()) return;
            navigator.geolocation.getCurrentPosition((pos) => {
                db.collection('posts').add({
                    text: text, category: category,
                    lat: pos.coords.latitude, lng: pos.coords.longitude,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    document.getElementById('post-text').value = '';
                    loadPosts();
                    alert("æŠ•ç¨¿ã—ã¾ã—ãŸï¼");
                });
            });
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7hvh-OUCTVM62geqN543IMtgEWl-eeTQ&callback=initMap"></script>
</body>
</html>
