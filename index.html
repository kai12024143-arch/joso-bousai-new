<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸¸ç·é˜²ç½ãƒãƒƒãƒ—</title>
    <style>
        #map { height: 600px; width: 100%; border: 1px solid #ccc; }
        body { font-family: sans-serif; margin: 20px; background-color: #f8f9fa; }
        h2 { text-align: center; color: #333; }
        #post-form { margin-top: 20px; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 600px; margin: 20px auto; }
        textarea { width: 100%; height: 80px; margin-bottom: 15px; display: block; border: 2px solid #eee; border-radius: 8px; padding: 10px; font-size: 16px; box-sizing: border-box; }
        select { margin-bottom: 15px; padding: 12px; font-size: 16px; width: 100%; border: 2px solid #eee; border-radius: 8px; background-color: #fff; }
        .legend { margin: 10px auto; padding: 15px; background: #fff; border-radius: 12px; text-align: center; font-size: 0.85em; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 600px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        button { padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
    </style>
</head>
<body>

    <h2>å¸¸ç·ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£é˜²ç½ãƒãƒƒãƒ—</h2>
    <div id="map"></div>

    <div class="legend">
        <div>ğŸš¨ èµ¤ï¼šæ•‘åŠ©è¦è«‹ï¼ˆå¤§ï¼‰</div>
        <div>âš ï¸ é»„ï¼šè¢«å®³ã‚ã‚Š</div>
        <div>âœ… ç·‘ï¼šè¢«å®³ãªã—</div>
        <div style="color:#666;">ï¼ˆæ·¡è‰²ã¯é€šå¸¸æ™‚ã®æƒ…å ±ï¼‰</div>
    </div>

    <form id="post-form">
        <label>ã€ä»Šã®çŠ¶æ³ã‚’é¸æŠã€‘</label>
        <select id="post-category">
            <optgroup label="ğŸš¨ ç·Šæ€¥ãƒ»è¢«å®³å ±å‘Š">
                <option value="red">ğŸ”´ æ•‘åŠ©è¦è«‹ï¼ˆè‡³æ€¥ï¼ï¼‰</option>
                <option value="yellow">ğŸŸ¡ è¢«å®³ã‚ã‚Šï¼ˆæµ¸æ°´ãƒ»æå£Šï¼‰</option>
                <option value="green">ğŸŸ¢ è¢«å®³ãªã—ï¼ˆç„¡äº‹å ±å‘Šï¼‰</option>
            </optgroup>
            <optgroup label="ğŸŒ¸ é€šå¸¸æ™‚ã®æƒ…å ±å…±æœ‰">
                <option value="pale-red">æ·¡ã„èµ¤ï¼ˆæ³¨æ„å–šèµ·ãƒ»å°è¦æ¨¡ãƒˆãƒ©ãƒ–ãƒ«ï¼‰</option>
                <option value="pale-blue">æ·¡ã„é’ï¼ˆæ°´å ´ãƒ»é“è·¯æƒ…å ±ï¼‰</option>
                <option value="pale-yellow">æ·¡ã„é»„ï¼ˆãŠåº—ãƒ»ç”Ÿæ´»æƒ…å ±ï¼‰</option>
                <option value="pale-green">æ·¡ã„ç·‘ï¼ˆè‡ªç„¶ãƒ»æ†©ã„ã®å ´ï¼‰</option>
            </optgroup>
        </select>

        <label>ã€è©³ç´°å†…å®¹ã€‘</label>
        <textarea id="post-text" placeholder="è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
        <button type="submit">æŠ•ç¨¿ã™ã‚‹</button>
    </form>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBMOr6Kag-PCGL6piRVtjCDukk01aurb1M",
            authDomain: "joso-13c95.firebaseapp.com",
            projectId: "joso-13c95",
            storageBucket: "joso-13c95.firebasestorage.app",
            messagingSenderId: "659788884587",
            appId: "1:659788884587:web:39b9a1b840039c24875f2e"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        let map;
        let markers = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14, center: { lat: 35.9897, lng: 139.9791 }
            });
            loadPosts(); 
        }

        // â˜…è‰²ã¨ã‚µã‚¤ã‚ºã‚’æŒ‡å®šã—ã¦ãƒ”ãƒ³ç”»åƒ(SVG)ã‚’ä½œã‚‹é–¢æ•°
        function createMarkerIcon(color, size) {
            return {
                path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z',
                fillColor: color,
                fillOpacity: 1,
                strokeColor: '#000',
                strokeWeight: 1,
                scale: size / 20, // åŸºæº–ã‚µã‚¤ã‚º20ã«å¯¾ã—ã¦ã®å€ç‡
                labelOrigin: new google.maps.Point(0, -30)
            };
        }

        function loadPosts() {
            markers.forEach(m => m.setMap(null));
            markers = [];

            db.collection('posts').orderBy('timestamp', 'desc').limit(50).get().then((snapshot) => {
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if(!data.lat || !data.lng) return;

                    let color = "#888"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    let size = 25;      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µã‚¤ã‚º

                    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã®è‰²ã¨ã‚µã‚¤ã‚ºè¨­å®š
                    switch(data.category) {
                        case "red": color = "#FF0000"; size = 50; break; // æ•‘åŠ©è¦è«‹ï¼šæ¿ƒã„èµ¤ãƒ»ç‰¹å¤§
                        case "yellow": color = "#FFD700"; size = 30; break; // è¢«å®³ã‚ã‚Šï¼šé‡‘/é»„ãƒ»ä¸­
                        case "green": color = "#32CD32"; size = 25; break;  // è¢«å®³ãªã—ï¼šç·‘ãƒ»é€šå¸¸
                        case "pale-red": color = "#FFADAD"; size = 22; break; // æ·¡ã„èµ¤
                        case "pale-blue": color = "#A0C4FF"; size = 22; break; // æ·¡ã„é’
                        case "pale-yellow": color = "#FDFFB6"; size = 22; break; // æ·¡ã„é»„
                        case "pale-green": color = "#CAFFBF"; size = 22; break; // æ·¡ã„ç·‘
                    }

                    const marker = new google.maps.Marker({
                        position: { lat: data.lat, lng: data.lng },
                        map: map,
                        icon: createMarkerIcon(color, size),
                        zIndex: (data.category === "red") ? 100 : 1
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="color:#333;">${data.text}</div>`
                    });

                    marker.addListener('click', () => infoWindow.open(map, marker));
                    markers.push(marker);
                });
            });
        }

        document.getElementById('post-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = document.getElementById('post-text').value;
            const category = document.getElementById('post-category').value;
            if (!text.trim()) return;

            navigator.geolocation.getCurrentPosition((pos) => {
                db.collection('posts').add({
                    text: text, category: category,
                    lat: pos.coords.latitude, lng: pos.coords.longitude,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    document.getElementById('post-text').value = '';
                    alert("æŠ•ç¨¿ã—ã¾ã—ãŸï¼");
                    loadPosts();
                });
            });
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7hvh-OUCTVM62geqN543IMtgEWl-eeTQ&callback=initMap"></script>
</body>
</html>
